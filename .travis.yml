language: python
python:
  - 3.6
env:
  global:
    # Doctr deploy key for moorepants/mae223
    - secure: "DUZO4HYuynYYff2aPwPdtdjjPDTgu7C091R2fo5rB+tH+a6RlmZhamsHPP3rnrjfgNHo7J9fbapJkqbTCWeegGCEzt+8K/dtFmIagAVDmL3rVBndiORE9sgOLMB1hmE+/UrR6R/JnejQYcia3Ki+OrUHNVEzd6OA2WsUAd6/TxmRjUlbxQW6UONVhWAaeEEnhoKBzcUzWSClsyXq+egrUJ0aWFCc8mYZ0LtlgvsO4yzl5RRZjLJ5OD6apBYdTv0DXpxg6pzqs5nIaCGn8Iev50Uh9j/4XZwsXqj2TScYdrUBCc9yQ8WavXKUEfDwtsJTPCW9RRnGOQTk+VD5w6Fb84pNd8Mkr0TplmBm2mHUa61Rbt7tqY6OWfYMHy6a6sh80ZVl9FOn5Fk2qzQA0pwiSgNlEteQQB28P68uq6NZEsMjrXXkCsBZ6tyW5uTvqXE71H4jHBIp4+BZ8I3Ynm4ed13ckYAo2kCXBL3IPoX4aQLCF3h8JMNXMo9zK0I+rnrX4FUa1gn/QeVpypC9hs5wn2717i6/FUjWz6NIJ1MqeGAVLJTBdMwgRmSH5iQ05iPikn/KW1mOMBgjfcSL5CfUDwaTP3M7MgluKw6plMiNV++SOVzTswlp+nBrKoRpBXf1xIoMwktZjxFqXm8mgP4gkeuJuT1wCQyMBUZUxjR2KwY="
install:
  - git clone --depth=1 https://github.com/getpelican/pelican-plugins.git
  - git clone --depth=1 --single-branch --branch mechmotum https://github.com/mechmotum/pelican-alchemy.git
  - wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  # This command failed with an error.
  #- conda update -q conda
  - conda env create -f pelican-env.yml
  - conda create -n doctr-env -c conda-forge doctr
before_script:
  - conda info -a
  - conda list -n pelican-env
  - conda list -n doctr-env
script:
  - set -e
  - source activate pelican-env
  - python -c "import pelican"
  - pelican -D -v --fatal errors -s publishconf.py
  - source deactivate
  - source activate doctr-env
  - if [[ -z "$TRAVIS_TAG" ]]; then
      DEPLOY_DIR=".";
    else
      DEPLOY_DIR="$TRAVIS_TAG";
    fi
  - doctr deploy --build-tags --built-docs output/ $DEPLOY_DIR
  - source deactivate
